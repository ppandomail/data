---
title: "Trabajo Práctico Final"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    code_folding: show
    df_print: paged
    theme: united
    code_download: true
editor_options: 
  markdown: 
    wrap: 72
---

```{css echo=FALSE}
.badCode {
background-color: white;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE, 
                      message = FALSE, 
                      eval = TRUE, 
                      fig.width = 6, 
                      fig.height = 4, 
                      fig.align = "center", 
                      class.source = "badCode") 
options(width = 90)
```

<br> <br>

|  |  |
|----------------|--------------------------------------------------------|
| **Universidad** | Universidad Nacional del Oeste |
| **Carrera** | Esp. en Ciencia de Datos |
| **Materia** | Fundamentos de Estadísticas (01050) |
| **Profesora** | Mg. Sc. Silvia N. Pérez |
| **Alumnos** | {Lic. Leticia Sosa, Ing. Federico Czerniawski, Mg. Pablo Pandolfo} |
| **Fecha** | Junio 2025 |
|  |  |

<br> <br>

## Librerias usadas

```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(hrbrthemes)
library(plotly)
library(tidyr)
library(tidyverse)
library(scales)
library(corrplot)
library(car)
library(nortest)
library(tseries)
```

<br> <br>

## Importación de la base de datos

```{r}
# Borramos ambiente de trabajo
rm(list = ls())
# Seteamos directorio de trabajo
setwd("/Users/ppando/Materias/data/materias/estadistica/tp_grupal")
# Cargamos datos del archivo
datos <- read_xlsx("seguros.xlsx")
# Mostramos los primeros 6 casos
head(datos)
```

<br> <br>

## Parte 1: análisis exploratorio

<br>

### a. Identificar el tipo de cada una de las variables registradas (cuali, cuanti)

```{r}
# Mostramos estructura de los datos
str(datos)
```
<br>

::: {style="background-color: lightgray; color: black"}
- cualitativas nominales = {Genero, Fuma, Region}
- cuantitativas: 
  - discretas = {Edad}
  - continuas = {IMC, ingreso, premio}
:::

<br>

### b. Decidir si hay datos faltantes, en cuyo caso eliminar los casos

```{r}
# Contamos número de nulos por variables (columnas)
sapply(datos, function(x) sum(is.na(x)))

# Eliminamos casos (filas) con nulos
datos <- datos[!is.na(datos$Fuma),]

# Verificamos que el caso con nulos fue eliminado
sapply(datos, function(x) sum(is.na(x)))
```

<br>

### c. Realizar boxplots para cada variable cuantitativa, separando según la/las variables cualitativas que considere importantes

```{r}
seguros_long_Genero <- datos %>%
  select(Edad, Genero, IMC, ingreso, premio) %>%
  pivot_longer(cols = -Genero, names_to = "variable", values_to = "valor")

ggplotly(
  ggplot(seguros_long_Genero, aes(x = Genero, y = valor, fill = Genero)) +
    geom_boxplot(alpha = 0.7) +
    facet_wrap(~ variable, scales = "free_y") +  # Un panel por variable
    theme_bw() +
    theme(legend.position = "none") +
    labs(
      title = "Distribución de variables por Genero",
      x = "Género",
      y = "Valor"
    )
)

seguros_long_Fuma <- datos %>%
  select(Edad, IMC, Fuma, ingreso, premio) %>%
  pivot_longer(cols = -Fuma, names_to = "variable", values_to = "valor")

ggplotly(
  ggplot(seguros_long_Fuma, aes(x = Fuma, y = valor, fill = Fuma)) +
    geom_boxplot(alpha = 0.7) +
    facet_wrap(~ variable, scales = "free_y") +  # Un panel por variable
    theme_bw() +
    theme(legend.position = "none") +
    labs(
      title = "Distribución de variables por Condición de Fumador",
      x = "Fuma",
      y = "Valor"
    )
)

seguros_long_Region <- datos %>%
  select(Edad, IMC, Region, ingreso, premio) %>%
  pivot_longer(cols = -Region, names_to = "variable", values_to = "valor")

ggplotly(
  ggplot(seguros_long_Region, aes(x = Region, y = valor, fill = Region)) +
    geom_boxplot(alpha = 0.7) +
    facet_wrap(~ variable, scales = "free_y") +  # Un panel por variable
    theme_bw() +
    theme(legend.position = "none") +
    labs(
      title = "Distribución de variables por Region",
      x = "Región",
      y = "Valor"
    )
)

```

::: {style="background-color: lightgray; color: black"}
Se observa que las variables cuantitativas agrupadas por las distintas cualitativas presentan distribuciones similares.

Además, la variable premio presenta un valor muy atípico.
:::

<br>

### d. Identificar si hay datos muy atípicos, en cuyo caso eliminar los casos

::: {style="background-color: lightgray; color: black"}
Como se concluye del análisis anterior, la variable premio presenta un valor muy atípico.

Procedemos a eliminarlo.
:::


```{r}
gplot = datos %>% filter(Genero == "femenino") %>% 
  ggplot(mapping = aes(x=Region, y=premio, color=Fuma)) +
  geom_point() +
  stat_summary(fun ="mean", geom="crossbar", color="red", linewidth=0.5) + # mostramos la media
  theme_bw() + xlab("Region") + ylab("Premio")

ggplotly(gplot)

# Lo eliminamos
datos <- datos %>% filter(premio != max(premio))
```

<br>

### e. Hallar las medidas resumen de cada variable cuantitativa, separando según lo hecho en el ítem anterior

```{r}
# Declaramos a las variables cualitativas como factor, para poder reconocer categorias
datos$Genero <- as.factor(datos$Genero)
datos$Fuma <- as.factor(datos$Fuma)
datos$Region <- as.factor(datos$Region)

# Mostramos medidas resumen
summary(datos)

# Volvemos a mostrar graficamente las medidas resumen de las variables cuantis agrupadas por las variables cualis
seguros_long_Genero <- datos %>%
  select(Edad, Genero, IMC, ingreso, premio) %>%
  pivot_longer(cols = -Genero, names_to = "variable", values_to = "valor")

ggplotly(
  ggplot(seguros_long_Genero, aes(x = Genero, y = valor, fill = Genero)) +
    geom_boxplot(alpha = 0.7) +
    facet_wrap(~ variable, scales = "free_y") +  # Un panel por variable
    theme_bw() +
    theme(legend.position = "none") +
    labs(
      title = "Distribución de variables por Genero",
      x = "Género",
      y = "Valor"
    )
)

seguros_long_Fuma <- datos %>%
  select(Edad, IMC, Fuma, ingreso, premio) %>%
  pivot_longer(cols = -Fuma, names_to = "variable", values_to = "valor")

ggplotly(
  ggplot(seguros_long_Fuma, aes(x = Fuma, y = valor, fill = Fuma)) +
    geom_boxplot(alpha = 0.7) +
    facet_wrap(~ variable, scales = "free_y") +  # Un panel por variable
    theme_bw() +
    theme(legend.position = "none") +
    labs(
      title = "Distribución de variables por Condición de Fumador",
      x = "Fuma",
      y = "Valor"
    )
)

seguros_long_Region <- datos %>%
  select(Edad, IMC, Region, ingreso, premio) %>%
  pivot_longer(cols = -Region, names_to = "variable", values_to = "valor")

ggplotly(
  ggplot(seguros_long_Region, aes(x = Region, y = valor, fill = Region)) +
    geom_boxplot(alpha = 0.7) +
    facet_wrap(~ variable, scales = "free_y") +  # Un panel por variable
    theme_bw() +
    theme(legend.position = "none") +
    labs(
      title = "Distribución de variables por Region",
      x = "Región",
      y = "Valor"
    )
)



```

<br>

### f. Calcular la correlación entre todos los pares posibles de variables numéricas

```{r}
# Calculamos la matriz de correlación que nos muestra los coeficientes de correlación entre cada para de variables. 
datos_numericos <- datos %>% select(Edad, IMC, ingreso, premio)
correlaciones <- cor(datos_numericos)
correlaciones

# Definimos una paleta de colores
colores <- colorRampPalette(c("blue", "white", "red"))(200)

# Visualizamos las correlaciones mediante un mapa de calor
corrplot(correlaciones, method = "color", col = colores, addCoef.col = "black")

# Visualizamos en un gráfico de dispersión la dependencia entre ingreso y premio
gplot = datos %>% 
  ggplot(mapping = aes(x=ingreso, y=premio, color=Genero)) +
  geom_point() +
  geom_smooth(formula= 'y ~ x', method = "lm", se = FALSE, color = "red") +
  theme_bw() + xlab("Ingreso") + ylab("Premio") + ggtitle("Relación entre ingreso y premio")

ggplotly(gplot)

# Visualizamos en un gráfico de dispersión la dependencia entre Edad e IMC
gplot = datos %>% 
  ggplot(mapping = aes(x=Edad, y=IMC, color=Genero)) +
  geom_point() +
  geom_smooth(formula= 'y ~ x', method = "lm", se = FALSE, color = "red") +
  theme_bw() + xlab("Edad") + ylab("IMC") + ggtitle("Relación entre Edad e IMC")

ggplotly(gplot)

```

::: {style="background-color: lightgray; color: black"}
En el gráfico se muestra claramente la correlación fuerte existente entre las variables ingreso y premio.

Además, las variables Edad e IMC presentan una correlación moderada.

Y las variables ingreso e IMC presentan una correlación débil.

El resto de las intersecciones no presentan correlaciones.
:::

<br> <br>

## Parte 2: inferencia estadística

::: {style="background-color: lightgray; color: black"}
1) Planteamos las hipótesis.
2) Evaluamos la independencia de las muestras.
3) Evaluamos normalidad. Se consideran las siguientes hipótesis >> H0: x es normal & H1: x no es normal
4) Evaluamos homogeneidad de varianzas. Se consideran las siguientes hipótesis >> H0: Hay homogeneidad de varianzas & H1: No hay homogeneidad. Sirve para evitar cometer errores tipo I (falsos positivos) o tipo II (falsos negativos) y que esto afecte la validez de los resultados 
5) Seleccionamos el estadístico de prueba según 2), 3) y 4) y hacemos la comparación
:::

<br>

### a. Realizar pruebas de comparación de medias para la variable IMC según si fuma o no

::: {style="background-color: lightgray; color: black"}
1) Planteamos las hipótesis
- Ho -> No hay diferencias entre las medias del IMC de los grupos "Fuma = sí" y "Fuma = no".
- H1 -> Hay diferencias entre las medias de los dos grupos.

- Tamaño de la muestra: 667
- Nivel de Significancia: 0.05
:::


::: {style="background-color: lightgray; color: black"}
2) Evaluamos la independencia de las muestras.
Considerando que:
- Son dos grupos totalmente distintos (Fuma=Si y Fuma=No) y un caso del grupo A no puede existir en el grupo B.
- La observación del Grupo A no puede inferir en la observación del Grupo B.
- No hay ninguna relación aparente entre ambos grupos.

Se consideran dos muestras independientes.
:::

::: {style="background-color: lightgray; color: black"}
3) Evaluamos normalidad. Se consideran las siguientes hipótesis >> H0: x es normal & H1: x no es normal
:::

```{r}
# Verificamos mediante un QQPlot
gplot <- datos %>%
  ggplot(aes(sample = IMC, color = Fuma)) +
  geom_qq() + geom_qq_line() +
  facet_wrap(~ Fuma) + 
  ggtitle("QQ-plot de IMC por estado de fumador") +
  theme_bw()

ggplotly(gplot)
```

::: {style="background-color: lightgray; color: black"}
Aparentemente ambas muestras siguen una distribución normal.

Verificamos con una función estadística (usamos Lilliefors porque el tamaño de la muestra es mayor a 50)
:::

```{r}
by(data = datos, INDICES = datos$Fuma, FUN = function(x) { lillie.test(x$IMC) })
```

::: {style="background-color: lightgray; color: black"}
p-value >= 0.05 en ambos grupos: NO hay evidencia estadística para rechazar H0, lo que indica que se puede suponer que los datos de la variable IMC siguen una distribución normal.

4) Evaluamos homogeneidad de varianzas. Se consideran las siguientes hipótesis >> H0: Hay homogeneidad de varianzas & H1: No hay homogeneidad 
:::

```{r}
bartlett.test(IMC ~ Fuma, data=datos)
leveneTest(IMC ~ Fuma, data=dataset) # Se usa cuando no se puede asegurar la normalidad
```

::: {style="background-color: lightgray; color: black"}
En ambos tests se observa un p-value alejado del 0.05, por lo cual no hay evidencia para rechazar H0, lo que permite suponer que hay homogeneidad de varianzas.

5) Seleccionamos el estadístico de prueba según 2), 3) y 4) y hacemos la comparación

Como las muestras se suponen con distribución normal y las varianzas homogéneas, se utilizará el t.test para hacer la prueba de hipótesis.
:::

<br>

### b. Realizar pruebas de comparación de medias para la variable ingreso según género. Si considera que hay alguna hipótesis de interés a probar, según lo observado en la Parte 1, realizar el test correspondiente

```{r}

```

<br>

### c. Realizar pruebas de comparación de medias para las variables IMC, ingreso y premio según Región

```{r}

```

<br>

### d. Probar si puede asumirse independencia entre la procedencia (Región) y la condición de fumador de la persona

```{r}

```

<br>
